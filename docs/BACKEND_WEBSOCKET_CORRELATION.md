# Backend WebSocket Correlation Instructions

## Problem
When HTTP POST `/edge/message` arrives, backend needs to know which WebSocket to use for instant reflex delivery.

## Solution: WebSocket Correlation via edge_agent_id

### 1. WebSocket Connection (Edge ‚Üí Backend)
Edge client connects with edge agent ID in query parameter:
```
wss://archety-backend-dev.up.railway.app/edge/ws?edge_agent_id=edge_13238407486
                                                    ^^^^^^^^^^^^^^^^^^^^^^^^
```

**Backend should:**
- Extract `edge_agent_id` from query parameter
- Store in a map: `websocketConnections[edge_agent_id] = websocket_connection`
- Example:
```python
websocket_connections = {}  # Global map

@app.websocket("/edge/ws")
async def websocket_endpoint(websocket, edge_agent_id: str):
    await websocket.accept()

    # Store the connection
    websocket_connections[edge_agent_id] = websocket

    try:
        while True:
            # Keep connection alive, handle pings
            await websocket.receive_text()
    finally:
        # Clean up on disconnect
        del websocket_connections[edge_agent_id]
```

### 2. HTTP Request (Edge ‚Üí Backend)
Edge client includes edge agent ID in header:
```
POST /edge/message
Authorization: Bearer <EDGE_SECRET>
X-Edge-Agent-Id: edge_13238407486
                 ^^^^^^^^^^^^^^^^^^
Content-Type: application/json

{
  "thread_id": "+15622924139",
  "sender": "+15622924139",
  "filtered_text": "Can you find me the best deal for a Mac mini?"
}
```

**Backend should:**
- Extract `X-Edge-Agent-Id` from request headers
- Look up WebSocket: `ws = websocket_connections[edge_agent_id]`
- If WebSocket exists and is connected, send reflex immediately

Example:
```python
@app.post("/edge/message")
async def handle_message(request: Request, edge_agent_id: str = Header(None, alias="X-Edge-Agent-Id")):
    # Process message, generate reflex
    reflex_text = "okie lemme see"  # Generated by LLM

    # Check if WebSocket is available
    if edge_agent_id and edge_agent_id in websocket_connections:
        ws = websocket_connections[edge_agent_id]

        # Send reflex IMMEDIATELY via WebSocket
        await ws.send_json({
            "type": "command",
            "data": {
                "command_id": str(uuid.uuid4()),
                "command_type": "send_message_now",
                "payload": {
                    "thread_id": request.thread_id,
                    "text": reflex_text,
                    "bubble_type": "reflex"
                },
                "priority": "immediate",
                "timestamp": datetime.now().isoformat()
            }
        })

        logger.info(f"üì§ Sent reflex via WebSocket to {edge_agent_id}: {reflex_text}")
    else:
        logger.warning(f"‚ö†Ô∏è WebSocket not found for {edge_agent_id}, will return reflex in HTTP response only")

    # Continue processing full response...
    # Return HTTP response with ALL bubbles (including reflex as fallback)
    return {
        "should_respond": True,
        "reply_bubbles": [reflex_text, "bubble 2", "bubble 3", ...]
    }
```

### 3. Edge Client Behavior
Edge client will:
- Receive reflex via WebSocket instantly
- Later receive HTTP response with all bubbles
- Skip first bubble in HTTP response (already sent via WS)

## Current Implementation Status

‚úÖ **Edge Client (Our Side):**
- WebSocket connecting with: `?edge_agent_id=edge_13238407486`
- HTTP requests include: `X-Edge-Agent-Id: edge_13238407486`
- Handler for `send_message_now` commands: Implemented
- Duplicate detection: Implemented

‚ùì **Backend (Their Side):**
- Need to confirm: WebSocket connection map implementation
- Need to confirm: Header extraction from HTTP requests
- Need to confirm: WebSocket lookup and send logic

## Testing

After backend implements correlation:

1. Edge connects WebSocket ‚Üí Backend stores `edge_13238407486`
2. User sends message ‚Üí Edge POSTs with `X-Edge-Agent-Id: edge_13238407486`
3. Backend looks up WebSocket ‚Üí Sends `send_message_now` instantly
4. Edge client receives and sends to iMessage in < 500ms ‚ö°

## Debug Logging

Backend should log:
```
[WebSocket] Connected: edge_13238407486 (total connections: 1)
[HTTP POST] Received from edge_13238407486
[Reflex] WebSocket found for edge_13238407486 ‚úÖ
[Reflex] Sent "okie lemme see" via WebSocket to edge_13238407486
```

If WebSocket not found:
```
[HTTP POST] Received from edge_13238407486
[Reflex] WebSocket NOT found for edge_13238407486 ‚ùå
[Reflex] Will return in HTTP response only (fallback mode)
```

## Questions for Backend Engineer

1. **WebSocket Connection Storage:**
   - Are you storing WebSocket connections in a map keyed by `edge_agent_id`?
   - Are you extracting the `edge_agent_id` from the query parameter during WebSocket handshake?

2. **HTTP Request Correlation:**
   - Are you extracting the `X-Edge-Agent-Id` header from `/edge/message` requests?
   - Are you looking up the WebSocket connection using this header value?

3. **Reflex Delivery:**
   - When a reflex is generated, are you checking if a WebSocket exists for the edge agent?
   - Are you sending the `send_message_now` command to that WebSocket?

4. **Error Handling:**
   - What happens if WebSocket is disconnected between message receipt and reflex generation?
   - Are you falling back to returning reflex in HTTP response?

## Created
November 17, 2025

## Related Documents
- `/Users/sage1/Downloads/WEBSOCKET_REFLEX_DELIVERY.md` - Backend's original spec
- `src/backend/WebSocketClient.ts` - Edge client WebSocket implementation
- `src/commands/CommandHandler.ts` - Command handler for `send_message_now`
